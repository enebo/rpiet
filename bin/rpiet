#!/usr/bin/env ruby

require 'optparse'
require 'rpiet'

run_ast = false
codel_size = 1

log = RPiet::Logger::NoOutput
opts = OptionParser.new do |opts|
  opts.banner = "Usage: #{__FILE__} -d image_file"

  opts.on("-g", "--graph", "execute AST(graph)") { run_ast = true }
  opts.on("-d", "--debug style", "turn on debugging") do |style|
    log = case style
    when 'simple'
      RPiet::Logger::SimpleAsciiOutput
    when 'complex'
      RPiet::Logger::ComplexAsciiOutput
    when 'graphical'
      RPiet::Logger::Graphical
    end
  end
  opts.on("-c", "--codel-size w", "size of codel") { |w| codel_size = w.to_i }
end

opts.parse!(ARGV)
opts.usage("You need to supply a source image filename.") unless ARGV.first

filename = ARGV.first

if filename =~ /.txt/
  require 'rpiet/image/ascii_image'
  image = RPiet::Image::AsciiImage.new(File.read(filename), codel_size)
else
  filename = 'file:' + ARGV.first if File.exist? filename
  require 'rpiet/image/url_image'
  image = RPiet::Image::URLImage.new(filename, codel_size)
end

if run_ast
  require 'rpiet/graph_interpreter'
  RPiet::GraphInterpreter.new(image, log.new).run
else
  RPiet::Interpreter.new(image, log.new).run
end
exit 0
